pipeline {
    agent {label "jdk17"}
    parameters {
    name: 'VERSION', defaultValue : '1.0.0', description : 'version du produit'
    }
    stages {
        stage('clone codebase') {
            steps {
                echo 'cloning project codebase'
                git (url : 'https://github.com/MarionMEDEVIELLE/maven-project.git', branch : 'master', credentialsId : 'credential4githubAccess')
            }
        }
        stage('compiling') {
            steps {
                echo 'project compiling'
                withMaven(maven : 'localMaven') {
                    sh "mvn compile"
                }
            }
        }
        stage('Testing') {
            steps {
                echo 'InitTests running'
                withMaven(maven : 'localMaven') {
                    sh "mvn test"
                }
            }
        }
        stage('Sonar Analysis') {
            steps {
                echo 'analyse sonarqube'
                withSonarQubeEnv(installationName : 'sonarServer', credentialsId : 'credentials4sonar')
                {
                    sh "mvn clean package sonar:sonar"
                }
            }
        }
        stage('Build') {
            steps {
                echo 'Compilation du projet sans tenir compte des classes de test : ${params.VERSION}'
                withMaven(maven : 'localMaven') {
                    sh "mvn -B -DskipTests clean install -Dproject.version = ${params.VERSION}"
                }
            }
        }
    }
}
